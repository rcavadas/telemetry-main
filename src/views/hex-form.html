<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöó Sistema de Telemetria Multi-Protocolo</title>
    <!-- Leaflet CSS for OpenStreetMap/OpenFreeMaps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Layout com Sidebar */
        .app-layout {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar Menu */
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        
        .sidebar-header {
            padding: 25px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            border-bottom: 2px solid rgba(255,255,255,0.2);
        }
        
        .sidebar-header h1 {
            font-size: 1.4em;
            margin: 0;
            font-weight: 600;
        }
        
        .sidebar-header p {
            font-size: 0.85em;
            margin-top: 5px;
            opacity: 0.9;
        }
        
        .sidebar-menu {
            padding: 15px 0;
        }
        
        .menu-item {
            display: block;
            padding: 15px 20px;
            color: #333;
            text-decoration: none;
            border-left: 4px solid transparent;
            transition: all 0.2s ease;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            position: relative;
        }
        
        .menu-item:hover {
            background: #f8f9fa;
            border-left-color: #667eea;
            color: #667eea;
        }
        
        .menu-item.active {
            background: #e7f1ff;
            border-left-color: #007acc;
            color: #007acc;
            font-weight: 600;
        }
        
        .menu-item-icon {
            margin-right: 12px;
            font-size: 1.2em;
            display: inline-block;
            width: 24px;
            text-align: center;
        }
        
        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            margin-top: auto;
            position: absolute;
            bottom: 0;
            width: 100%;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        
        /* Main Content Area */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 20px;
            min-height: 100vh;
            overflow-y: auto;
            scroll-behavior: auto;
        }
        
        /* Prevent any scroll jumps when switching pages */
        html {
            scroll-behavior: auto;
        }
        
        body {
            overflow-x: hidden;
        }
        
        .page-section {
            display: none !important;
        }
        
        .page-section.active {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        
        .main-header { 
            background: rgba(255,255,255,0.95); 
            padding: 30px; 
            border-radius: 16px; 
            margin-bottom: 20px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.1); 
            backdrop-filter: blur(10px); 
            text-align: center;
        }
        .title { font-size: 2.5em; margin: 0; color: #333; font-weight: 600; }
        .subtitle { color: #666; margin: 10px 0 20px 0; font-size: 1.1em; }
        
        .status-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 15px; 
            margin-top: 20px; 
        }
        .status-card { 
            background: #e8f5e8; 
            padding: 15px; 
            border-radius: 8px; 
            text-align: center; 
            font-weight: 500; 
            color: #2d5a2d; 
            border-left: 4px solid #28a745;
        }
        .status-card.error { background: #f8d7da; color: #721c24; border-left-color: #dc3545; }
        .status-card.warning { background: #fff3cd; color: #856404; border-left-color: #ffc107; }
        .status-card .status-value { font-size: 1.2em; font-weight: bold; }
        .status-card .status-label { font-size: 0.9em; margin-top: 5px; }
        
        .section { 
            background: rgba(255,255,255,0.95); 
            padding: 30px; 
            border-radius: 16px; 
            margin-bottom: 20px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.1); 
            backdrop-filter: blur(10px); 
        }
        .section h2 { color: #333; margin-bottom: 10px; }
        .section p { color: #666; margin-bottom: 20px; }
        
        /* TCP Monitor Styles */
        .tcp-monitor {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #28a745;
            margin-bottom: 20px;
        }
        .tcp-monitor-header {
            padding: 20px 20px 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .tcp-monitor-title {
            margin: 0;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .tcp-status {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }
        .status-dot.disconnected {
            background: #dc3545;
            animation: none;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .tcp-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .tcp-messages {
            padding: 0 20px 20px 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .tcp-message {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            border-left: 3px solid #007acc;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            animation: fadeIn 0.3s ease-in;
        }
        .tcp-message.new {
            background: #d1ecf1;
            border-left-color: #17a2b8;
        }
        .tcp-message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-weight: bold;
            color: #495057;
        }
        .tcp-message-time {
            font-size: 10px;
            color: #6c757d;
        }
        .tcp-message-data {
            background: #ffffff;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            word-break: break-all;
            line-height: 1.4;
        }
        .tcp-message-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 8px;
            font-size: 10px;
        }
        .tcp-message-meta span {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            color: #495057;
        }
        .no-messages {
            text-align: center;
            color: #6c757d;
            padding: 40px;
            font-style: italic;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .vehicles-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); 
            gap: 20px; 
            margin-top: 20px; 
        }
        .vehicle-card { 
            background: #fff; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
            border-left: 4px solid #007acc;
            position: relative;
        }
        .vehicle-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
        }
        .vehicle-title { margin: 0; color: #333; }
        .vehicle-year { 
            background: #e9ecef; 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-size: 12px; 
            color: #666; 
        }
        .vehicle-status { 
            position: absolute; 
            top: 15px; 
            right: 15px; 
            background: #28a745; 
            color: white; 
            padding: 2px 8px; 
            border-radius: 10px; 
            font-size: 10px; 
            font-weight: bold; 
        }
        .vehicle-device { 
            color: #666; 
            font-size: 12px; 
            margin-bottom: 15px; 
        }
        
        .vehicle-info { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
            margin-bottom: 15px;
        }
        .info-group h4 { 
            margin: 0 0 8px 0; 
            color: #333; 
            font-size: 14px; 
            border-bottom: 1px solid #eee; 
            padding-bottom: 4px;
        }
        .info-group p { 
            margin: 4px 0; 
            font-size: 13px; 
            color: #555;
        }
        .info-group strong { color: #333; }
        
        .vehicle-actions { 
            display: flex; 
            gap: 10px; 
            margin-top: 15px; 
            flex-wrap: wrap; 
        }
        .btn { 
            padding: 8px 16px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 12px; 
            text-decoration: none; 
            display: inline-block; 
            text-align: center;
        }
        .btn-primary { background: #007acc; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        
        .endpoints-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
            margin-top: 20px; 
        }
        .endpoint-card { 
            background: #fff; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
            border-left: 4px solid #17a2b8;
        }
        .endpoint-card h3 { color: #333; margin: 0 0 10px 0; }
        .endpoint-code { 
            background: #f8f9fa; 
            padding: 8px 12px; 
            border-radius: 4px; 
            font-family: 'Courier New', monospace; 
            font-size: 12px; 
            color: #495057; 
            margin: 10px 0;
        }
        .endpoint-example { 
            background: #fff3cd; 
            padding: 10px; 
            border-radius: 4px; 
            font-size: 11px; 
            margin: 10px 0;
        }
        
        /* Formul√°rio Hex */
        .hex-form { margin-top: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #333; 
        }
        .hex-input { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            font-family: 'Courier New', monospace; 
            font-size: 14px; 
            resize: vertical; 
            min-height: 100px; 
        }
        .hex-input:focus { 
            border-color: #007acc; 
            outline: none; 
            box-shadow: 0 0 0 3px rgba(0,122,204,0.1); 
        }
        .form-row { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px; 
            flex-wrap: wrap; 
        }
        .hex-results { 
            background: #d4edda; 
            border: 1px solid #c3e6cb; 
            border-radius: 8px; 
            padding: 15px; 
            margin-top: 15px; 
            display: none;
        }
        .hex-error { 
            background: #f8d7da; 
            border: 1px solid #f5c6cb; 
            border-radius: 8px; 
            padding: 15px; 
            margin-top: 15px; 
            display: none;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            position: relative;
        }

        /* Auth / Settings */
        .auth-status {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            font-size: 12px;
            color: #555;
        }
        .auth-badge {
            padding: 4px 8px;
            border-radius: 999px;
            background: #e9ecef;
            font-weight: 500;
        }
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        .settings-card {
            background: #fff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            border-left: 4px solid #007acc;
        }
        .settings-card h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: #333;
        }
        .settings-card small {
            display: block;
            margin-bottom: 8px;
            color: #777;
        }
        .settings-card label {
            display: block;
            font-size: 12px;
            margin-top: 8px;
            margin-bottom: 2px;
            color: #444;
        }
        .settings-card input,
        .settings-card select {
            width: 100%;
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #ced4da;
            font-size: 12px;
        }
        .settings-card table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            margin-top: 8px;
        }
        .settings-card th,
        .settings-card td {
            padding: 4px 6px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }
        .settings-tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 999px;
            font-size: 11px;
            background: #e9ecef;
        }
        .close {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }
        .close:hover { color: #333; }
        
        @media (max-width: 768px) { 
            .vehicles-grid { grid-template-columns: 1fr; }
            .vehicle-info { grid-template-columns: 1fr; }
            .endpoints-grid { grid-template-columns: 1fr; }
            .status-grid { grid-template-columns: 1fr; }
            .tcp-monitor-header { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar Menu -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>üöó Telemetria</h1>
                <p>Sistema Multi-Protocolo</p>
            </div>
            
            <nav class="sidebar-menu">
                <a href="#" class="menu-item active" onclick="console.log('Dashboard clicado'); showPage('dashboard'); return false;">
                    <span class="menu-item-icon">üìä</span>
                    Dashboard
                </a>
                <a href="#" class="menu-item" onclick="console.log('Ve√≠culos clicado'); showPage('vehicles'); return false;">
                    <span class="menu-item-icon">üöó</span>
                    Cadastro de Ve√≠culos
                </a>
                <a href="#" class="menu-item" onclick="console.log('API clicado'); showPage('api'); return false;">
                    <span class="menu-item-icon">üåê</span>
                    Endpoints API
                </a>
                <a href="#" class="menu-item" onclick="console.log('Configura√ß√µes clicado'); showPage('settings'); return false;">
                    <span class="menu-item-icon">‚öôÔ∏è</span>
                    Configura√ß√µes
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <div class="auth-status" style="text-align: center;">
                    <span id="authInfo" class="auth-badge" style="display: block; margin-bottom: 10px; text-align: center;">üîì N√£o autenticado</span>
                    <button class="btn btn-secondary" type="button" onclick="openLoginModal()" id="loginBtn" style="width: 100%; font-size: 12px; padding: 8px;">üîê Login</button>
                    <button class="btn btn-secondary" type="button" onclick="logout()" id="logoutBtn" style="display:none; width: 100%; font-size: 12px; padding: 8px;">Sair</button>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Page -->
            <div id="page-dashboard" class="page-section active">
                <div class="container">
                    <!-- Cabe√ßalho Principal -->
                    <div class="main-header">
                        <h1 class="title">üìä Dashboard</h1>
                        <p class="subtitle">Vis√£o geral do sistema de telemetria</p>
                        
                        <!-- Status Cards -->
                        <div class="status-grid">
                            <div class="status-card">
                                <div class="status-value">‚úÖ TCP: Porta 29479</div>
                                <div class="status-label">Servidor OBD</div>
                            </div>
                            <div class="status-card">
                                <div class="status-value">‚úÖ HTTP: Porta 3000</div>
                                <div class="status-label">API REST</div>
                            </div>
                            <div class="status-card">
                                <div class="status-value">‚úÖ Base de Dados Ativa</div>
                                <div class="status-label">SQLite + JSON</div>
                            </div>
                            <div class="status-card">
                                <div class="status-value" id="vehicleCount">üöó 0 Ve√≠culos Cadastrados</div>
                                <div class="status-label">Sistema Ativo</div>
                            </div>
                        </div>
                    </div>

                    <!-- Monitor TCP em Tempo Real -->
        <div class="section">
            <div class="tcp-monitor">
                <div class="tcp-monitor-header">
                    <h2 class="tcp-monitor-title">
                        üì° Monitor TCP - Porta 29479
                        <span class="status-indicator">
                            <span id="tcpStatusDot" class="status-dot"></span>
                            <span id="tcpStatusText">Conectando...</span>
                        </span>
                    </h2>
                    
                    <div class="tcp-status">
                        <div class="status-indicator">
                            üìä <span id="messageCount">0</span> mensagens
                        </div>
                        <div class="status-indicator">
                            üë• <span id="clientCount">0</span> clientes conectados
                        </div>
                        <div class="tcp-controls">
                            <button class="btn btn-secondary" onclick="clearTcpMessages()">üóëÔ∏è Limpar</button>
                            <button class="btn btn-primary" onclick="toggleTcpMonitor()">
                                <span id="monitorToggleText">‚è∏Ô∏è Pausar</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="tcp-messages" id="tcpMessages">
                    <div class="no-messages">
                        üîç Aguardando comunica√ß√µes TCP...
                        <br><small>As mensagens aparecer√£o aqui em tempo real quando dispositivos OBD se conectarem</small>
                    </div>
                </div>
            </div>
        </div>

                    <!-- Se√ß√£o do Mapa de Localiza√ß√£o -->
                    <div class="section">
                        <h2>üó∫Ô∏è Localiza√ß√£o dos Ve√≠culos</h2>
                        <p>Visualize a localiza√ß√£o em tempo real dos ve√≠culos no mapa</p>
                        
                        <div id="mapContainer" style="width: 100%; height: 500px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-top: 15px;">
                            <div id="vehicleMap" style="width: 100%; height: 100%;"></div>
                        </div>
                        
                        <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="refreshMap()">üîÑ Atualizar Mapa</button>
                            <button class="btn btn-secondary" onclick="toggleAutoRefresh()" id="autoRefreshBtn">‚è∏Ô∏è Auto-atualiza√ß√£o: Desligada</button>
                            <span id="mapStatus" style="padding: 8px 15px; background: #e8f5e8; border-radius: 6px; color: #2d5a2d; font-size: 0.9em;">
                                üìç Carregando ve√≠culos...
                            </span>
                        </div>
                    </div>

        <!-- Se√ß√£o de Upload de Arquivo -->
        <div class="section">
            <h2>üìÅ Upload de Arquivo com Dados Hex</h2>
            <p>Fa√ßa upload de um arquivo (txt, log, json, etc.) e o sistema extrair√° automaticamente todos os dados hexadecimais, decodificar√° e salvar√° no banco de dados</p>
            
            <div class="hex-form">
                <div class="form-group">
                    <label class="form-label" for="fileInput">Selecione um arquivo:</label>
                    <input type="file" id="fileInput" accept=".txt,.log,.json,.csv,.dat" style="
                        width: 100%;
                        padding: 10px;
                        border: 2px dashed #007acc;
                        border-radius: 8px;
                        background: #f8f9fa;
                        cursor: pointer;
                        font-size: 14px;
                    ">
                    <p style="margin-top: 10px; color: #666; font-size: 0.9em;">
                        Formatos suportados: TXT, LOG, JSON, CSV, DAT<br>
                        O sistema procurar√° por strings hexadecimais no arquivo e processar√° automaticamente
                    </p>
                </div>
                
                <div class="form-row">
                    <button type="button" class="btn btn-primary" onclick="uploadFile()" id="uploadBtn">üì§ Processar Arquivo</button>
                    <button type="button" class="btn btn-secondary" onclick="clearUploadResults()">üóëÔ∏è Limpar Resultados</button>
                </div>
                
                <div id="uploadResults" style="display: none; margin-top: 20px;">
                    <h3>üìä Resultado do Processamento</h3>
                    <div id="uploadResultContent"></div>
                </div>
                
                <div id="uploadError" style="display: none; margin-top: 20px; padding: 15px; background: #f8d7da; border-radius: 8px; color: #721c24;">
                    <h3>‚ùå Erro no Processamento</h3>
                    <div id="uploadErrorContent"></div>
                </div>
                
                <div id="uploadProgress" style="display: none; margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; color: #856404;">
                    <p>‚è≥ Processando arquivo... Por favor, aguarde.</p>
                </div>
            </div>
        </div>

        <!-- Se√ß√£o do Testador Hex -->
        <div class="section">
            <h2>üîç Testador de C√≥digos Hexadecimais</h2>
            <p>Decodifique dados hexadecimais OBD em tempo real usando a API integrada</p>
            
            <div class="hex-form">
                <div class="form-group">
                    <label class="form-label" for="hexInput">C√≥digo Hexadecimal:</label>
                    <textarea id="hexInput" class="hex-input" placeholder="Cole aqui o c√≥digo hexadecimal (ex: 40408600043231384C534142...)

Voc√™ pode incluir espa√ßos e quebras de linha - eles ser√£o removidos automaticamente." rows="4"></textarea>
                </div>
                
                <div class="form-row">
                    <button type="button" class="btn btn-primary" onclick="decodeHex()">üîç Decodificar</button>
                    <button type="button" class="btn btn-secondary" onclick="loadExample()">üìù Carregar Exemplo</button>
                    <button type="button" class="btn btn-secondary" onclick="clearResults()">üóëÔ∏è Limpar</button>
                </div>
                
                <div id="hexResults" class="hex-results">
                    <h3>üìä Resultado da Decodifica√ß√£o</h3>
                    <div id="hexResultContent"></div>
                </div>
                
                <div id="hexError" class="hex-error">
                    <h3>‚ùå Erro na Decodifica√ß√£o</h3>
                    <div id="hexErrorContent"></div>
                </div>
            </div>
        </div>

                </div>
            </div>
            
            <!-- Endpoints API Page -->
            <div id="page-api" class="page-section">
                <div class="container">
                    <div class="main-header">
                        <h1 class="title">üåê Endpoints da API</h1>
                        <p class="subtitle">Documenta√ß√£o e testes dos endpoints dispon√≠veis</p>
                    </div>

                    <div class="section">
                        <h2>üåê Endpoints da API</h2>
                        <p>Recursos dispon√≠veis para integra√ß√£o e consulta de dados</p>
                        
                        <div class="endpoints-grid">
                            <div class="endpoint-card">
                                <h3>üè• Health Check</h3>
                                <div class="endpoint-code">GET /health</div>
                                <p>Verifica o status dos servidores e recursos do sistema.</p>
                                <button class="btn btn-primary" onclick="testEndpoint('/health')">üîç Testar</button>
                            </div>
                            
                            <div class="endpoint-card">
                                <h3>üì± Listar Dispositivos</h3>
                                <div class="endpoint-code">GET /api/devices</div>
                                <p>Retorna lista de todos os dispositivos OBD com dados dispon√≠veis.</p>
                                <button class="btn btn-primary" onclick="testEndpoint('/api/devices')">üìã Ver Lista</button>
                            </div>
                            
                            <div class="endpoint-card">
                                <h3>üöó Listar Ve√≠culos</h3>
                                <div class="endpoint-code">GET /api/vehicles</div>
                                <p>Retorna lista de todos os ve√≠culos registrados na frota.</p>
                                <button class="btn btn-primary" onclick="testEndpoint('/api/vehicles')">üöó Ver Ve√≠culos</button>
                            </div>
                            
                            <div class="endpoint-card">
                                <h3>üîß Atualizar Ve√≠culo</h3>
                                <div class="endpoint-code">PUT /api/vehicles/:deviceId</div>
                                <p>Atualiza informa√ß√µes de um ve√≠culo espec√≠fico.</p>
                                <div class="endpoint-example">Exemplo: PUT /api/vehicles/218LSAB2025000004</div>
                            </div>
                            
                            <div class="endpoint-card">
                                <h3>üìä Relat√≥rio JSON</h3>
                                <div class="endpoint-code">GET /api/reports/:deviceId</div>
                                <p>Gera relat√≥rio completo de an√°lise do dispositivo em formato JSON.</p>
                                <button class="btn btn-primary" onclick="testEndpoint('/api/reports/218LSAB2025000004')">üìä Testar</button>
                            </div>
                            
                            <div class="endpoint-card">
                                <h3>üìÑ Relat√≥rio Markdown</h3>
                                <div class="endpoint-code">GET /api/reports/:deviceId/markdown</div>
                                <p>Baixa relat√≥rio detalhado em formato Markdown.</p>
                                <button class="btn btn-success" onclick="downloadReport('/api/reports/218LSAB2025000004/markdown')">üì• Download</button>
                            </div>
                            
                            <div class="endpoint-card">
                                <h3>üì° Leituras Brutas</h3>
                                <div class="endpoint-code">GET /api/readings/:deviceId</div>
                                <p>Retorna dados brutos de telemetria do dispositivo.</p>
                                <button class="btn btn-primary" onclick="testEndpoint('/api/readings/218LSAB2025000004')">üìä Ver Dados</button>
                            </div>
                            
                            <div class="endpoint-card">
                                <h3>üîç Decoder Hexadecimal</h3>
                                <div class="endpoint-code">POST /api/decode-hex</div>
                                <p>Decodifica dados hexadecimais OBD em tempo real.</p>
                                <div class="endpoint-example">Body: {"hex": "40408600..."}</div>
                                <button class="btn btn-primary" onclick="document.getElementById('hexInput').scrollIntoView()">üîç Usar Testador</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Configura√ß√µes Page -->
            <div id="page-settings" class="page-section">
                <div class="container">
                    <div class="main-header">
                        <h1 class="title">‚öôÔ∏è Configura√ß√µes do Sistema</h1>
                        <p class="subtitle">Configure portas e gerencie usu√°rios do sistema</p>
                    </div>

                    <div class="section">
                        <h2>‚öôÔ∏è Configura√ß√µes do Sistema</h2>
                        <p>Configure portas do servidor e gerencie usu√°rios. Apenas administradores podem alterar estas op√ß√µes.</p>

                        <div id="settingsWarning" style="font-size: 12px; color: #856404; background:#fff3cd; padding:8px 10px; border-radius:6px; margin-bottom:10px;">
                            Para alterar configura√ß√µes, fa√ßa login como administrador.
                        </div>

                        <div class="settings-grid" id="settingsGrid" style="opacity:0.6; pointer-events:none;">
                            <div class="settings-card">
                                <h3>üîå Portas do Servidor</h3>
                                <small>Modifique as portas HTTP e TCP. O servidor reinicia internamente nessas portas ap√≥s salvar.</small>
                                <label for="httpPortInput">Porta HTTP</label>
                                <input id="httpPortInput" type="number" min="1" max="65535" value="3000">
                                <label for="tcpPortInput">Porta TCP (OBD)</label>
                                <input id="tcpPortInput" type="number" min="1" max="65535" value="29479">
                                <button class="btn btn-primary" style="margin-top:10px;" type="button" onclick="saveServerSettings()">üíæ Salvar Portas</button>
                                <div id="settingsStatus" style="margin-top:8px; font-size:12px; color:#555;"></div>
                            </div>

                            <div class="settings-card">
                                <h3>üë• Usu√°rios</h3>
                                <small>Crie usu√°rios com n√≠vel de acesso administrador ou apenas visualiza√ß√£o.</small>
                                <label for="newUsername">Usu√°rio</label>
                                <input id="newUsername" type="text" placeholder="novo usu√°rio">
                                <label for="newPassword">Senha</label>
                                <input id="newPassword" type="password" placeholder="senha">
                                <label for="newRole">N√≠vel de Acesso</label>
                                <select id="newRole">
                                    <option value="user">Usu√°rio (visualiza√ß√£o)</option>
                                    <option value="admin">Administrador</option>
                                </select>
                                <button class="btn btn-primary" style="margin-top:10px;" type="button" onclick="createUser()">‚ûï Criar Usu√°rio</button>
                                <div id="usersStatus" style="margin-top:8px; font-size:12px; color:#555;"></div>
                                <table id="usersTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Usu√°rio</th>
                                            <th>Papel</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- preenchido via JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Cadastro de Ve√≠culos Page -->
            <div id="page-vehicles" class="page-section">
                <div class="container">
                    <div class="main-header">
                        <h1 class="title">üöó Cadastro de Ve√≠culos</h1>
                        <p class="subtitle">Gerencie a frota de ve√≠culos monitorados</p>
                    </div>

                    <div class="section">
                        <h2>üöó Ve√≠culos Registrados</h2>
                        <p>Frota monitorada pelo sistema de telemetria</p>
                        
                        <div class="vehicles-grid" id="vehiclesContainer">
                            <!-- Ve√≠culos ser√£o carregados dinamicamente -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de Login -->
        <div id="loginModal" class="modal">
            <div class="modal-content" style="max-width:400px;">
                <span class="close" onclick="closeLoginModal()">&times;</span>
                <h2>üîê Login</h2>
                <p style="font-size:13px; color:#555; margin-bottom:10px;">Entre com seu usu√°rio e senha para acessar as configura√ß√µes administrativas.</p>
                <div class="form-group">
                    <label class="form-label" for="loginUsername">Usu√°rio</label>
                    <input type="text" id="loginUsername">
                </div>
                <div class="form-group">
                    <label class="form-label" for="loginPassword">Senha</label>
                    <input type="password" id="loginPassword">
                </div>
                <div class="vehicle-actions">
                    <button class="btn btn-secondary" type="button" onclick="closeLoginModal()">Cancelar</button>
                    <button class="btn btn-primary" type="button" onclick="performLogin()">Entrar</button>
                </div>
                <div id="loginError" style="display:none; margin-top:10px; font-size:12px; color:#dc3545;"></div>
            </div>
        </div>

        <!-- Modal de Edi√ß√£o -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2>üìù Editar Ve√≠culo</h2>
                <form id="editForm">
                    <input type="hidden" id="editDeviceId">
                    
                    <div class="form-group">
                        <label>Marca:</label>
                        <input type="text" id="editBrand" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Modelo:</label>
                        <input type="text" id="editModel" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Ano:</label>
                        <input type="number" id="editYear" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Placa:</label>
                        <input type="text" id="editPlate" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Capacidade do Tanque (L):</label>
                        <input type="number" id="editTankCapacity" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Transmiss√£o:</label>
                        <select id="editTransmission" required>
                            <option value="Manual">Manual</option>
                            <option value="Autom√°tico">Autom√°tico</option>
                            <option value="CVT">CVT</option>
                            <option value="Tiptronic">Tiptronic</option>
                        </select>
                    </div>
                    
                    <div class="vehicle-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                        <button type="submit" class="btn btn-success">Salvar Altera√ß√µes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // PAGE NAVIGATION
        // ========================================
        
        // Make function globally accessible
        window.showPage = function(pageId) {
            console.log('üìÑ Navegando para p√°gina:', pageId);
            console.log('   Total de p√°ginas encontradas:', document.querySelectorAll('.page-section').length);
            
            // Hide all pages
            const pages = document.querySelectorAll('.page-section');
            console.log('   Ocultando', pages.length, 'p√°ginas');
            pages.forEach(page => {
                page.classList.remove('active');
                console.log('     - Ocultado:', page.id);
            });
            
            // Show selected page
            const targetPage = document.getElementById('page-' + pageId);
            console.log('   Procurando elemento: page-' + pageId);
            if (targetPage) {
                // Check parent hierarchy
                let parent = targetPage.parentElement;
                let hierarchy = [];
                while (parent && parent !== document.body) {
                    hierarchy.push(`${parent.tagName}.${parent.className}`);
                    parent = parent.parentElement;
                }
                console.log('   üìä Hierarquia de parents:', hierarchy);
                
                targetPage.classList.add('active');
                console.log('   ‚úÖ P√°gina exibida:', targetPage.id);
                console.log('   ‚úÖ Classes da p√°gina:', targetPage.className);
                const computedStyle = window.getComputedStyle(targetPage);
                console.log('   ‚úÖ Display computed:', computedStyle.display);
                console.log('   ‚úÖ Visibility:', computedStyle.visibility);
                console.log('   ‚úÖ Opacity:', computedStyle.opacity);
                console.log('   ‚úÖ Position:', computedStyle.position);
                console.log('   ‚úÖ Width:', computedStyle.width);
                console.log('   ‚úÖ Height:', computedStyle.height);
                console.log('   ‚úÖ Parent:', targetPage.parentElement?.tagName, targetPage.parentElement?.className);
                
                // Check if page is actually in viewport (for debugging only)
                const rect = targetPage.getBoundingClientRect();
                console.log('   ‚úÖ Bounding rect:', {
                    top: rect.top,
                    left: rect.left,
                    width: rect.width,
                    height: rect.height,
                    visible: rect.top >= 0 && rect.left >= 0 && rect.width > 0 && rect.height > 0
                });
                
                // NO SCROLL - Pages should appear in place without any movement
            } else {
                console.error('   ‚ùå P√°gina n√£o encontrada: page-' + pageId);
                console.error('   Elementos dispon√≠veis:', Array.from(document.querySelectorAll('[id^="page-"]')).map(el => el.id));
                return;
            }
            
            // Update menu active state
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => {
                item.classList.remove('active');
            });
            
            // Find and activate the clicked menu item
            const clickedItem = Array.from(menuItems).find(item => {
                return item.getAttribute('onclick')?.includes("'" + pageId + "'");
            });
            if (clickedItem) {
                clickedItem.classList.add('active');
            }
            
            // Special handling for map initialization
            if (pageId === 'dashboard' && typeof vehicleMap === 'undefined') {
                setTimeout(() => {
                    if (typeof initMap === 'function') {
                        initMap();
                    }
                }, 500);
            }
            
            // Refresh map if dashboard is shown
            if (pageId === 'dashboard' && typeof vehicleMap !== 'undefined' && vehicleMap) {
                setTimeout(() => {
                    if (typeof loadVehicleLocations === 'function') {
                        loadVehicleLocations();
                    }
                }, 300);
            }
            
            // Load vehicles if vehicles page is shown
            if (pageId === 'vehicles') {
                setTimeout(() => {
                    if (typeof loadVehicles === 'function') {
                        console.log('üöó Carregando ve√≠culos na p√°gina de cadastro...');
                        loadVehicles();
                    } else {
                        console.error('‚ùå Fun√ß√£o loadVehicles n√£o encontrada');
                    }
                }, 100);
            }
            
            // Load settings if settings page is shown
            if (pageId === 'settings') {
                setTimeout(() => {
                    if (typeof loadServerSettings === 'function') {
                        console.log('‚öôÔ∏è Carregando configura√ß√µes...');
                        loadServerSettings();
                    } else {
                        console.error('‚ùå Fun√ß√£o loadServerSettings n√£o encontrada');
                    }
                    if (typeof loadUsers === 'function') {
                        console.log('üë• Carregando usu√°rios...');
                        loadUsers();
                    } else {
                        console.error('‚ùå Fun√ß√£o loadUsers n√£o encontrada');
                    }
                }, 100);
            }
        };
        
        // Verify function is available
        console.log('‚úÖ Fun√ß√£o showPage dispon√≠vel:', typeof window.showPage === 'function');
        
        // Test page elements exist on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                console.log('üîç Verificando elementos das p√°ginas ap√≥s DOMContentLoaded:');
                ['dashboard', 'vehicles', 'api', 'settings'].forEach(pageId => {
                    const el = document.getElementById('page-' + pageId);
                    if (el) {
                        const style = window.getComputedStyle(el);
                        console.log(`   ‚úÖ page-${pageId}: encontrado, classes: ${el.className}, display: ${style.display}, visibility: ${style.visibility}`);
                    } else {
                        console.error(`   ‚ùå page-${pageId}: N√ÉO ENCONTRADO`);
                    }
                });
            });
        } else {
            console.log('üîç Verificando elementos das p√°ginas (DOM j√° carregado):');
            ['dashboard', 'vehicles', 'api', 'settings'].forEach(pageId => {
                const el = document.getElementById('page-' + pageId);
                if (el) {
                    const style = window.getComputedStyle(el);
                    console.log(`   ‚úÖ page-${pageId}: encontrado, classes: ${el.className}, display: ${style.display}, visibility: ${style.visibility}`);
                } else {
                    console.error(`   ‚ùå page-${pageId}: N√ÉO ENCONTRADO`);
                }
            });
        }
        
        // ========================================
        // AUTH / SETTINGS
        // ========================================

        let authToken = null;
        let authRole = null;
        let authUsername = null;

        function loadAuthFromStorage() {
            try {
                const stored = localStorage.getItem('telemetry_auth');
                if (!stored) return;
                const parsed = JSON.parse(stored);
                authToken = parsed.token || null;
                authRole = parsed.role || null;
                authUsername = parsed.username || null;
            } catch (e) {
                console.warn('Erro ao carregar auth do localStorage', e);
            }
        }

        function saveAuthToStorage() {
            if (!authToken) {
                localStorage.removeItem('telemetry_auth');
                return;
            }
            const data = {
                token: authToken,
                role: authRole,
                username: authUsername
            };
            localStorage.setItem('telemetry_auth', JSON.stringify(data));
        }

        function getAuthHeaders() {
            const headers = { 'Content-Type': 'application/json' };
            if (authToken) {
                headers['Authorization'] = 'Bearer ' + authToken;
            }
            return headers;
        }

        function updateAuthUI() {
            const authInfo = document.getElementById('authInfo');
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const settingsGrid = document.getElementById('settingsGrid');
            const settingsWarning = document.getElementById('settingsWarning');

            if (!authInfo || !loginBtn || !logoutBtn || !settingsGrid || !settingsWarning) return;

            if (authToken && authRole) {
                authInfo.textContent = `üîê ${authUsername || 'usu√°rio'} (${authRole})`;
                authInfo.style.background = authRole === 'admin' ? '#d4edda' : '#e2e3e5';
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';

                if (authRole === 'admin') {
                    settingsGrid.style.opacity = '1';
                    settingsGrid.style.pointerEvents = 'auto';
                    settingsWarning.style.display = 'none';
                    loadServerSettings();
                    loadUsers();
                } else {
                    settingsGrid.style.opacity = '0.6';
                    settingsGrid.style.pointerEvents = 'none';
                    settingsWarning.style.display = 'block';
                }
            } else {
                authInfo.textContent = 'üîì N√£o autenticado';
                authInfo.style.background = '#e9ecef';
                loginBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
                settingsGrid.style.opacity = '0.6';
                settingsGrid.style.pointerEvents = 'none';
                settingsWarning.style.display = 'block';
            }
        }

        function openLoginModal() {
            const modal = document.getElementById('loginModal');
            if (modal) modal.style.display = 'block';
            const loginError = document.getElementById('loginError');
            if (loginError) {
                loginError.style.display = 'none';
                loginError.textContent = '';
            }
        }

        function closeLoginModal() {
            const modal = document.getElementById('loginModal');
            if (modal) modal.style.display = 'none';
        }

        async function performLogin() {
            const usernameInput = document.getElementById('loginUsername');
            const passwordInput = document.getElementById('loginPassword');
            const errorEl = document.getElementById('loginError');
            if (!usernameInput || !passwordInput || !errorEl) return;

            const username = usernameInput.value.trim();
            const password = passwordInput.value;

            if (!username || !password) {
                errorEl.textContent = 'Informe usu√°rio e senha.';
                errorEl.style.display = 'block';
                return;
            }

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Falha no login');
                }

                authToken = data.data.token;
                authRole = data.data.role;
                authUsername = data.data.username;
                saveAuthToStorage();
                closeLoginModal();
                updateAuthUI();
            } catch (error) {
                errorEl.textContent = 'Credenciais inv√°lidas ou erro no servidor.';
                errorEl.style.display = 'block';
                console.error('Erro no login', error);
            }
        }

        function logout() {
            authToken = null;
            authRole = null;
            authUsername = null;
            saveAuthToStorage();
            updateAuthUI();
        }

        async function loadServerSettings() {
            try {
                const response = await fetch('/api/settings', {
                    method: 'GET',
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    console.warn('Falha ao carregar configura√ß√µes', data.error);
                    return;
                }
                const settings = data.data;
                const httpPortInput = document.getElementById('httpPortInput');
                const tcpPortInput = document.getElementById('tcpPortInput');
                if (httpPortInput && tcpPortInput) {
                    httpPortInput.value = settings.httpPort;
                    tcpPortInput.value = settings.tcpPort;
                }
            } catch (error) {
                console.error('Erro ao carregar configura√ß√µes', error);
            }
        }

        async function saveServerSettings() {
            const httpPortInput = document.getElementById('httpPortInput');
            const tcpPortInput = document.getElementById('tcpPortInput');
            const statusEl = document.getElementById('settingsStatus');
            if (!httpPortInput || !tcpPortInput || !statusEl) return;

            const httpPort = parseInt(httpPortInput.value, 10);
            const tcpPort = parseInt(tcpPortInput.value, 10);

            if (!httpPort || !tcpPort) {
                statusEl.textContent = 'Informe portas v√°lidas.';
                statusEl.style.color = '#dc3545';
                return;
            }

            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ httpPort, tcpPort })
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    statusEl.textContent = data.error || 'Erro ao salvar configura√ß√µes.';
                    statusEl.style.color = '#dc3545';
                    return;
                }
                statusEl.textContent = 'Configura√ß√µes salvas. Servidores HTTP/TCP reiniciados nas novas portas.';
                statusEl.style.color = '#28a745';
            } catch (error) {
                console.error('Erro ao salvar configura√ß√µes', error);
                statusEl.textContent = 'Erro ao salvar configura√ß√µes.';
                statusEl.style.color = '#dc3545';
            }
        }

        async function loadUsers() {
            const tableBody = document.querySelector('#usersTable tbody');
            const statusEl = document.getElementById('usersStatus');
            if (!tableBody || !statusEl) return;

            try {
                const response = await fetch('/api/users', {
                    method: 'GET',
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    statusEl.textContent = data.error || 'Erro ao carregar usu√°rios.';
                    statusEl.style.color = '#dc3545';
                    return;
                }
                tableBody.innerHTML = '';
                data.data.forEach(function(user) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td><span class="settings-tag">${user.role}</span></td>
                        <td>
                            <button class="btn btn-secondary" type="button" onclick="deleteUser(${user.id})" style="font-size:11px; padding:4px 8px;">üóëÔ∏è Remover</button>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
                statusEl.textContent = '';
            } catch (error) {
                console.error('Erro ao carregar usu√°rios', error);
                statusEl.textContent = 'Erro ao carregar usu√°rios.';
                statusEl.style.color = '#dc3545';
            }
        }

        async function createUser() {
            const usernameInput = document.getElementById('newUsername');
            const passwordInput = document.getElementById('newPassword');
            const roleSelect = document.getElementById('newRole');
            const statusEl = document.getElementById('usersStatus');
            if (!usernameInput || !passwordInput || !roleSelect || !statusEl) return;

            const username = usernameInput.value.trim();
            const password = passwordInput.value;
            const role = roleSelect.value;

            if (!username || !password) {
                statusEl.textContent = 'Informe usu√°rio e senha.';
                statusEl.style.color = '#dc3545';
                return;
            }

            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ username, password, role })
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    statusEl.textContent = data.error || 'Erro ao criar usu√°rio.';
                    statusEl.style.color = '#dc3545';
                    return;
                }
                statusEl.textContent = 'Usu√°rio criado com sucesso.';
                statusEl.style.color = '#28a745';
                usernameInput.value = '';
                passwordInput.value = '';
                loadUsers();
            } catch (error) {
                console.error('Erro ao criar usu√°rio', error);
                statusEl.textContent = 'Erro ao criar usu√°rio.';
                statusEl.style.color = '#dc3545';
            }
        }

        async function deleteUser(id) {
            const statusEl = document.getElementById('usersStatus');
            if (!statusEl) return;
            if (!confirm('Tem certeza que deseja remover este usu√°rio?')) return;

            try {
                const response = await fetch('/api/users/' + id, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    statusEl.textContent = data.error || 'Erro ao remover usu√°rio.';
                    statusEl.style.color = '#dc3545';
                    return;
                }
                statusEl.textContent = 'Usu√°rio removido.';
                statusEl.style.color = '#28a745';
                loadUsers();
            } catch (error) {
                console.error('Erro ao remover usu√°rio', error);
                statusEl.textContent = 'Erro ao remover usu√°rio.';
                statusEl.style.color = '#dc3545';
            }
        }

        // ========================================
        // TCP MONITOR REAL-TIME FUNCTIONALITY
        // ========================================
        
        let tcpEventSource = null;
        let tcpMonitorPaused = false;
        let tcpMessageCount = 0;
        let connectedClients = new Set();
        
        function initTcpMonitor() {
            try {
                connectToTcpStream();
            } catch (error) {
                console.error('‚ùå Erro ao inicializar TCP Monitor:', error);
            }
        }
        
        function connectToTcpStream() {
            console.log('üîå Conectando ao TCP stream...');
            
            if (tcpEventSource) {
                console.log('   Fechando conex√£o anterior...');
                tcpEventSource.close();
                tcpEventSource = null;
            }
            
            try {
                console.log('   Criando novo EventSource...');
                tcpEventSource = new EventSource('/api/tcp-stream');
                console.log('   EventSource criado, readyState:', tcpEventSource.readyState);
            } catch (error) {
                console.error('‚ùå Erro ao criar EventSource:', error);
                console.error('   Stack:', error.stack);
                updateTcpStatus('disconnected', 'Erro ao conectar');
                return;
            }
            
            tcpEventSource.onopen = function(event) {
                console.log('‚úÖ TCP Monitor conectado (onopen)');
                console.log('   ReadyState:', tcpEventSource.readyState);
                console.log('   URL:', tcpEventSource.url);
                updateTcpStatus('connected', 'Conectado');
            };
            
            tcpEventSource.onmessage = function(event) {
                console.log('üì® Mensagem recebida do TCP stream:', event.data.substring(0, 100));
                if (!tcpMonitorPaused) {
                    try {
                        const message = JSON.parse(event.data);
                        addTcpMessage(message);
                    } catch (error) {
                        console.error('‚ùå Erro ao parsear mensagem TCP:', error);
                        console.error('   Data recebida:', event.data);
                    }
                }
            };
            
            tcpEventSource.onerror = function(event) {
                console.error('‚ùå Erro na conex√£o TCP Monitor');
                console.error('   ReadyState:', tcpEventSource.readyState);
                console.error('   Event:', event);
                console.error('   URL:', tcpEventSource.url);
                
                if (tcpEventSource.readyState === EventSource.CLOSED) {
                    console.log('   Conex√£o fechada, tentando reconectar em 5 segundos...');
                    updateTcpStatus('disconnected', 'Reconectando...');
                    setTimeout(() => {
                        connectToTcpStream();
                    }, 5000);
                } else {
                    updateTcpStatus('disconnected', 'Erro de conex√£o');
                }
            };
        }
        
        function addTcpMessage(message) {
            const messagesContainer = document.getElementById('tcpMessages');
            
            const noMessages = messagesContainer.querySelector('.no-messages');
            if (noMessages) {
                noMessages.remove();
            }
            
            tcpMessageCount++;
            connectedClients.add(message.clientId);
            updateCounters();
            
            const messageElement = document.createElement('div');
            messageElement.className = 'tcp-message new';
            
            const timestamp = new Date(message.timestamp).toLocaleString('pt-BR');
            const rawHex = message.rawHex;
            const deviceInfo = message.deviceId ? `Device: ${message.deviceId}` : 'Device: N/A';
            const sizeInfo = `${message.size} bytes`;
            const crcInfo = message.crcValid !== undefined ? (message.crcValid ? '‚úÖ CRC OK' : '‚ùå CRC Erro') : 'CRC: N/A';
            
            messageElement.innerHTML = `
                <div class="tcp-message-header">
                    <span>üì° ${message.messageType}</span>
                    <span class="tcp-message-time">${timestamp}</span>
                </div>
                <div class="tcp-message-data">${rawHex}</div>
                <div class="tcp-message-meta">
                    <span>üë§ ${message.clientId}</span>
                    <span>üì± ${deviceInfo}</span>
                    <span>üìè ${sizeInfo}</span>
                    <span>${crcInfo}</span>
                </div>
            `;
            
            messagesContainer.insertBefore(messageElement, messagesContainer.firstChild);
            
            setTimeout(() => {
                messageElement.classList.remove('new');
            }, 1000);
            
            const messages = messagesContainer.querySelectorAll('.tcp-message');
            if (messages.length > 50) {
                for (let i = 50; i < messages.length; i++) {
                    messages[i].remove();
                }
            }
        }
        
        function updateTcpStatus(status, text) {
            const statusDot = document.getElementById('tcpStatusDot');
            const statusText = document.getElementById('tcpStatusText');
            
            if (status === 'connected') {
                statusDot.className = 'status-dot';
                statusText.textContent = text;
            } else {
                statusDot.className = 'status-dot disconnected';
                statusText.textContent = text;
            }
        }
        
        function updateCounters() {
            document.getElementById('messageCount').textContent = tcpMessageCount;
            document.getElementById('clientCount').textContent = connectedClients.size;
        }
        
        function clearTcpMessages() {
            const messagesContainer = document.getElementById('tcpMessages');
            messagesContainer.innerHTML = `
                <div class="no-messages">
                    üóëÔ∏è Mensagens limpas. Aguardando novas comunica√ß√µes...
                    <br><small>As mensagens aparecer√£o aqui em tempo real quando dispositivos OBD se conectarem</small>
                </div>
            `;
            tcpMessageCount = 0;
            updateCounters();
        }
        
        function toggleTcpMonitor() {
            const toggleBtn = document.getElementById('monitorToggleText');
            
            tcpMonitorPaused = !tcpMonitorPaused;
            
            if (tcpMonitorPaused) {
                toggleBtn.textContent = '‚ñ∂Ô∏è Retomar';
                updateTcpStatus('disconnected', 'Pausado');
            } else {
                toggleBtn.textContent = '‚è∏Ô∏è Pausar';
                updateTcpStatus('connected', 'Conectado');
            }
        }

        // ========================================
        // VEHICLE MANAGEMENT
        // ========================================
        
        async function loadVehicles() {
            try {
                const container = document.getElementById('vehiclesContainer');
                if (!container) {
                    console.error('‚ùå Container de ve√≠culos n√£o encontrado');
                    return;
                }
                
                container.innerHTML = '<p style="text-align: center; color: #666;">‚è≥ Carregando ve√≠culos...</p>';
                
                const response = await fetch('/api/vehicles');
                const result = await response.json();
                
                if (result.success && result.data && result.data.vehicles) {
                    const vehicles = result.data.vehicles;
                    
                    // Update vehicle count in header
                    const vehicleCountEl = document.getElementById('vehicleCount');
                    if (vehicleCountEl) {
                        vehicleCountEl.textContent = `üöó ${vehicles.length} Ve√≠culos Cadastrados`;
                    }
                    
                    if (vehicles.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #666;">Nenhum ve√≠culo cadastrado ainda.</p>';
                        return;
                    }
                    
                    container.innerHTML = vehicles.map(vehicle => createVehicleCard(vehicle)).join('');
                    console.log(`‚úÖ ${vehicles.length} ve√≠culo(s) carregado(s)`);
                } else {
                    console.error('‚ùå Erro ao carregar ve√≠culos:', result.error);
                    container.innerHTML = '<p style="text-align: center; color: #dc3545;">Erro ao carregar ve√≠culos. Verifique o console para mais detalhes.</p>';
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar ve√≠culos:', error);
                const container = document.getElementById('vehiclesContainer');
                if (container) {
                    container.innerHTML = '<p style="text-align: center; color: #dc3545;">Erro de conex√£o ao carregar ve√≠culos.</p>';
                }
            }
        }
        
        function createVehicleCard(vehicle) {
            try {
                const specs = vehicle.vehicleSpecs || {};
                const operational = vehicle.operationalData || {};
                const deviceId = vehicle.deviceInfo?.deviceId || vehicle.deviceId || 'N/A';
                
                // Escape HTML to prevent XSS
                const escapeHtml = (text) => {
                    if (!text) return 'N/A';
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                };
                
                return `
                    <div class="vehicle-card">
                        <div class="vehicle-status">ACTIVE</div>
                        <div class="vehicle-header">
                            <h3 class="vehicle-title">${escapeHtml(specs.brand || 'N/A')} ${escapeHtml(specs.model || 'N/A')}</h3>
                            <span class="vehicle-year">${escapeHtml(specs.year || 'N/A')}</span>
                        </div>
                        <div class="vehicle-device">${escapeHtml(deviceId)}</div>
                        
                        <div class="vehicle-info">
                            <div class="info-group">
                                <h4>üîß Motor</h4>
                                <p><strong>${escapeHtml(specs.engine?.displacement || 'N/A')}</strong></p>
                                <p><strong>${escapeHtml(specs.engine?.power || 'N/A')}</strong></p>
                            </div>
                            
                            <div class="info-group">
                                <h4>‚õΩ Combust√≠vel</h4>
                                <p><strong>${specs.fuel?.tankCapacityLiters || 'N/A'}L</strong></p>
                                <p>${escapeHtml(specs.fuel?.type || 'gasoline')}</p>
                            </div>
                            
                            <div class="info-group">
                                <h4>üèéÔ∏è Transmiss√£o</h4>
                                <p><strong>${escapeHtml(specs.transmission || 'N/A')}</strong></p>
                            </div>
                            
                            <div class="info-group">
                                <h4>üè∑Ô∏è Categoria</h4>
                                <p><strong>${escapeHtml(specs.category || 'N/A')}</strong></p>
                            </div>
                        </div>
                        
                        <div class="info-group">
                            <h4>üìä Dados Operacionais</h4>
                            <p>üìç <strong>Local:</strong> ${escapeHtml(operational.location || 'N/A')}</p>
                            <p>üõ£Ô∏è <strong>Dist√¢ncia Total:</strong> ${escapeHtml(operational.totalDistance || '0')}</p>
                            <p>‚ö° <strong>Velocidade M√©dia:</strong> ${escapeHtml(operational.averageSpeed || '0')}</p>
                            <p>üìÖ <strong>√öltima Atualiza√ß√£o:</strong> ${escapeHtml(operational.lastUpdate || 'N/A')}</p>
                        </div>
                        
                        <div class="vehicle-actions">
                            <button class="btn btn-primary" onclick="openReport('${escapeHtml(deviceId)}')">üìä Ver Relat√≥rio</button>
                            <button class="btn btn-secondary" onclick="openReadings('${escapeHtml(deviceId)}')">üì° Ver Leituras</button>
                            <button class="btn btn-success" onclick="openEditModal('${escapeHtml(deviceId)}')">‚úèÔ∏è Editar</button>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Erro ao criar card de ve√≠culo:', error, vehicle);
                return `<div class="vehicle-card"><p style="color: red;">Erro ao renderizar ve√≠culo: ${error.message}</p></div>`;
            }
        }

        // ========================================
        // HEX DECODER FUNCTIONALITY
        // ========================================
        
        async function decodeHex() {
            const hexInput = document.getElementById('hexInput');
            const resultsDiv = document.getElementById('hexResults');
            const errorDiv = document.getElementById('hexError');
            const resultContent = document.getElementById('hexResultContent');
            const errorContent = document.getElementById('hexErrorContent');
            
            const hexValue = hexInput.value.trim().replace(/\s+/g, '');
            
            if (!hexValue) {
                showError('Por favor, insira um c√≥digo hexadecimal v√°lido');
                return;
            }
            
            try {
                const response = await fetch('/api/decode-hex', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hex: hexValue })
                });
                
                const result = await response.json();
                
                if (result.success && result.data && result.data.decoded) {
                    showResults(result);
                } else {
                    showError(result.error || 'Erro na decodifica√ß√£o');
                }
            } catch (error) {
                showError('Erro de conex√£o: ' + error.message);
            }
        }
        
        function showResults(result) {
            const resultsDiv = document.getElementById('hexResults');
            const errorDiv = document.getElementById('hexError');
            const resultContent = document.getElementById('hexResultContent');
            
            errorDiv.style.display = 'none';
            resultsDiv.style.display = 'block';
            
            const decoded = result.data.decoded;
            const savedToDB = result.data.savedToDatabase;
            const readingId = result.data.readingId;
            
            let html = `
                <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 6px;">
                    <h4>üì± Informa√ß√µes B√°sicas</h4>
                    <p><strong>Device ID:</strong> ${decoded.deviceId}</p>
                    <p><strong>Protocolo:</strong> ${decoded.protocolId}</p>
                    <p><strong>Timestamp:</strong> ${new Date(decoded.timestamp).toLocaleString('pt-BR')}</p>
                    <p><strong>Tempo de processamento:</strong> ${result.processingTime || 'N/A'}</p>
                    ${savedToDB ? `<p style="color: #28a745; font-weight: bold;">üíæ Dados salvos no banco (ID: ${readingId})</p>` : ''}
                </div>
            `;
            
            if (decoded.gps && (decoded.gps.latitude !== 0 || decoded.gps.longitude !== 0)) {
                // If data was saved and has GPS, refresh the map
                if (savedToDB && vehicleMap) {
                    setTimeout(() => {
                        loadVehicleLocations();
                    }, 1000); // Wait 1 second for database to be ready
                }
                html += `
                    <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 6px;">
                        <h4>üìç Dados GPS</h4>
                        <p><strong>Coordenadas:</strong> ${decoded.gps.latitude.toFixed(6)}, ${decoded.gps.longitude.toFixed(6)}</p>
                        <p><strong>Velocidade:</strong> ${decoded.gps.speedKmH} km/h</p>
                        <p><strong>Dire√ß√£o:</strong> ${decoded.gps.direction}¬∞</p>
                        <p><strong>Sat√©lites:</strong> ${decoded.gps.satellites}</p>
                        <p><strong>Fix GPS:</strong> ${decoded.gps.gpsFix}</p>
                        <p><strong>Data/Hora:</strong> ${decoded.gps.date} ${decoded.gps.time}</p>
                        ${savedToDB ? `
                            <div style="margin-top: 10px; padding: 8px; background: #e8f5e8; border-radius: 4px;">
                                <p style="margin: 0; color: #2d5a2d; font-weight: bold;">‚úÖ Localiza√ß√£o salva e atualizada no mapa!</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            if (decoded.tripData) {
                html += `
                    <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 6px;">
                        <h4>üõ£Ô∏è Dados da Viagem</h4>
                        <p><strong>Km Total:</strong> ${decoded.tripData.totalOdometer?.toLocaleString('pt-BR', {maximumFractionDigits: 1}) || 'N/A'} km</p>
                        <p><strong>Km Viagem:</strong> ${decoded.tripData.currentMileage?.toLocaleString('pt-BR') || 'N/A'} km</p>
                        <p><strong>Combust√≠vel Total:</strong> ${((decoded.tripData.totalFuel || 0) / 100).toFixed(1)} L</p>
                        <p><strong>Combust√≠vel Viagem:</strong> ${((decoded.tripData.currentFuel || 0) / 100).toFixed(1)} L</p>
                    </div>
                `;
            }
            
            if (decoded.vehicleState) {
                html += `
                    <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 6px;">
                        <h4>üîã Estado do Ve√≠culo</h4>
                        <p><strong>Power:</strong> ${decoded.vehicleState.powerOn ? 'ON' : 'OFF'}</p>
                        <p><strong>ACC:</strong> ${decoded.vehicleState.accOn ? 'ON' : 'OFF'}</p>
                        <p><strong>Igni√ß√£o:</strong> ${decoded.vehicleState.ignitionOn ? 'ON' : 'OFF'}</p>
                        ${decoded.voltage ? `<p><strong>Tens√£o:</strong> ${decoded.voltage}V</p>` : ''}
                    </div>
                `;
            }
            
            if (decoded.versions) {
                html += `
                    <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 6px;">
                        <h4>üíø Vers√µes</h4>
                        <p><strong>Software:</strong> ${decoded.versions.software || 'N/A'}</p>
                        <p><strong>Hardware:</strong> ${decoded.versions.hardware || 'N/A'}</p>
                    </div>
                `;
            }
            
            if (result.data.analysis) {
                html += `
                    <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 6px;">
                        <h4>üîç An√°lise Estrutural</h4>
                        <p><strong>Header:</strong> ${result.data.analysis.header}</p>
                        <p><strong>Tamanho:</strong> ${result.data.analysis.length} bytes</p>
                        <p><strong>Device ID extra√≠do:</strong> ${result.data.analysis.deviceId}</p>
                        <p><strong>Protocolo detectado:</strong> ${result.data.analysis.protocol}</p>
                    </div>
                `;
            }
            
            resultContent.innerHTML = html;
        }
        
        function showError(message) {
            const resultsDiv = document.getElementById('hexResults');
            const errorDiv = document.getElementById('hexError');
            const errorContent = document.getElementById('hexErrorContent');
            
            resultsDiv.style.display = 'none';
            errorDiv.style.display = 'block';
            errorContent.innerHTML = `<p>${message}</p>`;
        }
        
        function loadExample() {
            const hexInput = document.getElementById('hexInput');
            const exampleHex = '40408600043231384C534142323032353030303030343BD020090000000000000000000000000004108A1100010001000000000000000100FEFF000000140000000000110101010000000000000000020014240027';
            hexInput.value = exampleHex;
        }
        
        function clearResults() {
            const hexInput = document.getElementById('hexInput');
            const resultsDiv = document.getElementById('hexResults');
            const errorDiv = document.getElementById('hexError');
            
            hexInput.value = '';
            resultsDiv.style.display = 'none';
            errorDiv.style.display = 'none';
        }

        // ========================================
        // API TESTING FUNCTIONS
        // ========================================
        
        function testEndpoint(endpoint) {
            window.open(endpoint, '_blank');
        }
        
        function downloadReport(endpoint) {
            window.location.href = endpoint;
        }
        
        function openReport(deviceId) {
            window.open(`/api/reports/${deviceId}`, '_blank');
        }
        
        function openReadings(deviceId) {
            window.open(`/api/readings/${deviceId}`, '_blank');
        }

        // ========================================
        // MODAL FUNCTIONS
        // ========================================
        
        function openEditModal(deviceId) {
            document.getElementById('editModal').style.display = 'block';
            document.getElementById('editDeviceId').value = deviceId;
            // Aqui voc√™ pode carregar os dados do ve√≠culo para edi√ß√£o
        }
        
        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // ========================================
        // MAP FUNCTIONALITY (OpenFreeMaps/OpenStreetMap)
        // ========================================
        
        let vehicleMap = null;
        let vehicleMarkers = {};
        let autoRefreshEnabled = false;
        let autoRefreshInterval = null;
        
        function initMap() {
            // Check if Leaflet is loaded
            if (typeof L === 'undefined') {
                console.error('‚ùå Leaflet n√£o est√° carregado. Tentando novamente...');
                setTimeout(initMap, 1000);
                return;
            }
            
            try {
                // Initialize map centered on Brazil (default location)
                vehicleMap = L.map('vehicleMap').setView([-15.7975, -47.8919], 5);
                
                // Add OpenStreetMap tile layer (OpenFreeMaps compatible)
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19
                }).addTo(vehicleMap);
                
                // Load vehicle locations
                loadVehicleLocations();
            } catch (error) {
                console.error('‚ùå Erro ao inicializar mapa:', error);
                const statusEl = document.getElementById('mapStatus');
                if (statusEl) {
                    statusEl.textContent = '‚ùå Erro ao carregar mapa';
                    statusEl.style.background = '#f8d7da';
                    statusEl.style.color = '#721c24';
                }
            }
        }
        
        // Store GPS routes and points
        let gpsRoutes = {};
        let gpsPoints = [];
        
        // Helper function to get color based on speed
        function getSpeedColor(speedKmH) {
            if (speedKmH === undefined || speedKmH === null || speedKmH === 0) {
                return '#6c757d'; // Gray for stopped/unknown
            } else if (speedKmH < 30) {
                return '#007bff'; // Blue for low speed
            } else if (speedKmH < 60) {
                return '#28a745'; // Green for medium-low speed
            } else if (speedKmH < 90) {
                return '#ffc107'; // Yellow for medium-high speed
            } else {
                return '#dc3545'; // Red for high speed
            }
        }
        
        // Helper function to create arrow icon
        function createArrowIcon(color, direction, speedKmH) {
            // Rotate arrow based on direction (0-360 degrees)
            const rotation = direction || 0;
            
            // Arrow SVG pointing up (north), will be rotated
            const arrowSvg = `
                <svg width="24" height="24" viewBox="0 0 24 24" style="transform: rotate(${rotation}deg);">
                    <path d="M12 2 L16 10 L13 10 L13 20 L11 20 L11 10 L8 10 Z" 
                          fill="${color}" 
                          stroke="white" 
                          stroke-width="1.5"
                          stroke-linejoin="round"/>
                </svg>
            `;
            
            return L.divIcon({
                className: 'speed-arrow-marker',
                html: arrowSvg,
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });
        }
        
        async function loadVehicleLocations() {
            try {
                const statusEl = document.getElementById('mapStatus');
                statusEl.textContent = 'üìç Carregando todos os dados GPS...';
                statusEl.style.background = '#fff3cd';
                statusEl.style.color = '#856404';
                
                // Fetch all GPS readings
                const gpsResponse = await fetch('/api/gps-all');
                const gpsData = await gpsResponse.json();
                
                if (!gpsData.success || !gpsData.data) {
                    throw new Error('Erro ao carregar dados GPS');
                }
                
                const allReadings = gpsData.data.readings || [];
                const groupedByDevice = gpsData.data.groupedByDevice || {};
                
                // Clear existing markers and routes
                Object.values(vehicleMarkers).forEach(marker => {
                    vehicleMap.removeLayer(marker);
                });
                vehicleMarkers = {};
                
                Object.values(gpsRoutes).forEach(route => {
                    vehicleMap.removeLayer(route);
                });
                gpsRoutes = {};
                
                gpsPoints.forEach(point => {
                    vehicleMap.removeLayer(point);
                });
                gpsPoints = [];
                
                let vehiclesWithGPS = 0;
                let totalPoints = 0;
                let bounds = [];
                
                // Color palette for different vehicles
                const colors = ['#28a745', '#007bff', '#ffc107', '#dc3545', '#6f42c1', '#fd7e14', '#20c997', '#e83e8c'];
                let colorIndex = 0;
                
                // Process each device
                for (const [deviceId, readings] of Object.entries(groupedByDevice)) {
                    if (!readings || readings.length === 0) continue;
                    
                    const color = colors[colorIndex % colors.length];
                    colorIndex++;
                    
                    // Get vehicle info
                    let vehicleName = deviceId;
                    try {
                        const vehiclesResponse = await fetch('/api/vehicles');
                        const vehiclesData = await vehiclesResponse.json();
                        if (vehiclesData.success && vehiclesData.data.vehicles) {
                            const vehicle = vehiclesData.data.vehicles.find(v => v.deviceId === deviceId);
                            if (vehicle) {
                                vehicleName = vehicle.model || vehicle.plate || vehicle.deviceId;
                            }
                        }
                    } catch (e) {
                        console.warn('Erro ao buscar info do ve√≠culo:', e);
                    }
                    
                    // Create route polyline
                    const routeCoordinates = readings
                        .filter(r => r.latitude && r.longitude && r.latitude !== 0 && r.longitude !== 0)
                        .map(r => [r.latitude, r.longitude]);
                    
                    if (routeCoordinates.length > 1) {
                        const polyline = L.polyline(routeCoordinates, {
                            color: color,
                            weight: 4,
                            opacity: 0.7,
                            smoothFactor: 1
                        }).addTo(vehicleMap);
                        
                        polyline.bindPopup(`
                            <div style="min-width: 200px;">
                                <h3 style="margin: 0 0 10px 0; color: #333;">üöó ${vehicleName}</h3>
                                <p style="margin: 5px 0;"><strong>Device ID:</strong> ${deviceId}</p>
                                <p style="margin: 5px 0;"><strong>üìç Pontos GPS:</strong> ${routeCoordinates.length}</p>
                                <p style="margin: 5px 0;"><strong>üïê Per√≠odo:</strong><br>
                                    ${new Date(readings[0].timestamp).toLocaleString('pt-BR')}<br>
                                    at√©<br>
                                    ${new Date(readings[readings.length - 1].timestamp).toLocaleString('pt-BR')}</p>
                            </div>
                        `);
                        
                        gpsRoutes[deviceId] = polyline;
                        bounds.push(...routeCoordinates);
                    }
                    
                    // Add arrow markers for ALL GPS points
                    if (readings.length > 0) {
                        // Calculate direction for each point based on next point
                        for (let i = 0; i < readings.length; i++) {
                            const reading = readings[i];
                            
                            if (!reading.latitude || !reading.longitude || 
                                reading.latitude === 0 || reading.longitude === 0) {
                                continue;
                            }
                            
                            // Calculate direction: use reading direction if available, otherwise calculate from next point
                            let direction = reading.direction || 0;
                            
                            // If no direction in reading, calculate from next point
                            if (direction === 0 && i < readings.length - 1) {
                                const nextReading = readings[i + 1];
                                if (nextReading.latitude && nextReading.longitude) {
                                    // Calculate bearing between two points
                                    const lat1 = reading.latitude * Math.PI / 180;
                                    const lon1 = reading.longitude * Math.PI / 180;
                                    const lat2 = nextReading.latitude * Math.PI / 180;
                                    const lon2 = nextReading.longitude * Math.PI / 180;
                                    
                                    const dLon = lon2 - lon1;
                                    const y = Math.sin(dLon) * Math.cos(lat2);
                                    const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
                                    direction = (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
                                }
                            }
                            
                            // Get color based on speed
                            const speed = reading.speedKmH || 0;
                            const arrowColor = getSpeedColor(speed);
                            
                            // Create arrow icon
                            const arrowIcon = createArrowIcon(arrowColor, direction, speed);
                            
                            // Create marker
                            const marker = L.marker([reading.latitude, reading.longitude], { 
                                icon: arrowIcon,
                                rotationAngle: direction,
                                rotationOrigin: 'center'
                            }).addTo(vehicleMap);
                            
                            // Bind popup with reading info
                            const popupContent = `
                                <div style="min-width: 200px;">
                                    <h3 style="margin: 0 0 10px 0; color: #333;">üöó ${vehicleName}</h3>
                                    <p style="margin: 5px 0;"><strong>Device ID:</strong> ${deviceId}</p>
                                    <p style="margin: 5px 0;"><strong>üìç Coordenadas:</strong><br>
                                        ${reading.latitude.toFixed(6)}, ${reading.longitude.toFixed(6)}</p>
                                    ${speed > 0 ? `<p style="margin: 5px 0;"><strong>‚ö° Velocidade:</strong> ${speed.toFixed(1)} km/h <span style="display: inline-block; width: 12px; height: 12px; background: ${arrowColor}; border-radius: 2px; margin-left: 5px;"></span></p>` : '<p style="margin: 5px 0;"><strong>‚ö° Velocidade:</strong> Parado</p>'}
                                    ${direction > 0 ? `<p style="margin: 5px 0;"><strong>üß≠ Dire√ß√£o:</strong> ${direction.toFixed(0)}¬∞</p>` : ''}
                                    ${reading.satellites !== undefined ? `<p style="margin: 5px 0;"><strong>üõ∞Ô∏è Sat√©lites:</strong> ${reading.satellites}</p>` : ''}
                                    <p style="margin: 5px 0;"><strong>üïê Data/Hora:</strong><br>
                                        ${new Date(reading.timestamp).toLocaleString('pt-BR')}</p>
                                    <p style="margin: 5px 0; font-size: 11px; color: #666;">Ponto ${i + 1} de ${readings.length}</p>
                                    <button onclick="vehicleMap.setView([${reading.latitude}, ${reading.longitude}], 18);" 
                                            style="margin-top: 10px; padding: 5px 10px; background: #007acc; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        üîç Focar
                                    </button>
                                </div>
                            `;
                            
                            marker.bindPopup(popupContent);
                            
                            gpsPoints.push(marker);
                            bounds.push([reading.latitude, reading.longitude]);
                            totalPoints++;
                        }
                        
                        // Mark latest position with a special marker (larger, with border)
                        const latestReading = readings[readings.length - 1];
                        if (latestReading.latitude && latestReading.longitude && 
                            latestReading.latitude !== 0 && latestReading.longitude !== 0) {
                            
                            const latestSpeed = latestReading.speedKmH || 0;
                            const latestColor = getSpeedColor(latestSpeed);
                            const latestDirection = latestReading.direction || 0;
                            
                            // Larger arrow for current position
                            const latestArrowSvg = `
                                <svg width="32" height="32" viewBox="0 0 24 24" style="transform: rotate(${latestDirection}deg); filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));">
                                    <path d="M12 2 L16 10 L13 10 L13 20 L11 20 L11 10 L8 10 Z" 
                                          fill="${latestColor}" 
                                          stroke="white" 
                                          stroke-width="2"
                                          stroke-linejoin="round"/>
                                    <circle cx="12" cy="12" r="3" fill="white" opacity="0.8"/>
                                </svg>
                            `;
                            
                            const latestIcon = L.divIcon({
                                className: 'current-position-marker',
                                html: latestArrowSvg,
                                iconSize: [32, 32],
                                iconAnchor: [16, 16]
                            });
                            
                            const latestMarker = L.marker([latestReading.latitude, latestReading.longitude], { 
                                icon: latestIcon,
                                zIndexOffset: 1000 // Ensure it's on top
                            }).addTo(vehicleMap);
                            
                            latestMarker.bindPopup(`
                                <div style="min-width: 200px;">
                                    <h3 style="margin: 0 0 10px 0; color: #333;">üöó ${vehicleName}</h3>
                                    <p style="margin: 5px 0;"><strong>üìç Posi√ß√£o Atual</strong></p>
                                    <p style="margin: 5px 0;"><strong>Coordenadas:</strong><br>
                                        ${latestReading.latitude.toFixed(6)}, ${latestReading.longitude.toFixed(6)}</p>
                                    ${latestSpeed > 0 ? `<p style="margin: 5px 0;"><strong>‚ö° Velocidade:</strong> ${latestSpeed.toFixed(1)} km/h</p>` : '<p style="margin: 5px 0;"><strong>‚ö° Velocidade:</strong> Parado</p>'}
                                    ${latestReading.timestamp ? `<p style="margin: 5px 0;"><strong>üïê √öltima atualiza√ß√£o:</strong><br>${new Date(latestReading.timestamp).toLocaleString('pt-BR')}</p>` : ''}
                                    <p style="margin: 5px 0;"><strong>üìç Total de pontos GPS:</strong> ${readings.length}</p>
                                    <button onclick="vehicleMap.setView([${latestReading.latitude}, ${latestReading.longitude}], 18);" 
                                            style="margin-top: 10px; padding: 5px 10px; background: #007acc; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        üîç Focar
                                    </button>
                                </div>
                            `);
                            
                            vehicleMarkers[deviceId] = latestMarker;
                            vehiclesWithGPS++;
                        }
                    }
                }
                
                // Fit map to show all data
                if (bounds.length > 0) {
                    // If bounds are too small (points very close), zoom in more
                    const latRange = Math.max(...bounds.map(b => b[0])) - Math.min(...bounds.map(b => b[0]));
                    const lonRange = Math.max(...bounds.map(b => b[1])) - Math.min(...bounds.map(b => b[1]));
                    
                    if (latRange < 0.001 && lonRange < 0.001) {
                        // Points are very close, zoom to center with higher zoom level
                        const centerLat = (Math.max(...bounds.map(b => b[0])) + Math.min(...bounds.map(b => b[0]))) / 2;
                        const centerLon = (Math.max(...bounds.map(b => b[1])) + Math.min(...bounds.map(b => b[1]))) / 2;
                        vehicleMap.setView([centerLat, centerLon], 18);
                    } else {
                        vehicleMap.fitBounds(bounds, { padding: [50, 50], maxZoom: 18 });
                    }
                }
                
                // Update status
                statusEl.textContent = `‚úÖ ${vehiclesWithGPS} ve√≠culo(s) | ${totalPoints} pontos GPS | ${Object.keys(groupedByDevice).length} trajetos`;
                statusEl.style.background = '#e8f5e8';
                statusEl.style.color = '#2d5a2d';
                
                // Add legend for speed colors
                if (!document.getElementById('speedLegend')) {
                    const legend = document.createElement('div');
                    legend.id = 'speedLegend';
                    legend.style.cssText = `
                        position: absolute;
                        bottom: 30px;
                        right: 10px;
                        background: white;
                        padding: 15px;
                        border-radius: 8px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                        z-index: 1000;
                        font-size: 12px;
                    `;
                    legend.innerHTML = `
                        <div style="font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">‚ö° Velocidade</div>
                        <div style="margin: 5px 0;"><span style="display: inline-block; width: 16px; height: 16px; background: #007bff; border-radius: 2px; margin-right: 5px;"></span>Azul: 0-30 km/h</div>
                        <div style="margin: 5px 0;"><span style="display: inline-block; width: 16px; height: 16px; background: #28a745; border-radius: 2px; margin-right: 5px;"></span>Verde: 30-60 km/h</div>
                        <div style="margin: 5px 0;"><span style="display: inline-block; width: 16px; height: 16px; background: #ffc107; border-radius: 2px; margin-right: 5px;"></span>Amarelo: 60-90 km/h</div>
                        <div style="margin: 5px 0;"><span style="display: inline-block; width: 16px; height: 16px; background: #dc3545; border-radius: 2px; margin-right: 5px;"></span>Vermelho: 90+ km/h</div>
                        <div style="margin: 5px 0;"><span style="display: inline-block; width: 16px; height: 16px; background: #6c757d; border-radius: 2px; margin-right: 5px;"></span>Cinza: Parado</div>
                    `;
                    document.getElementById('vehicleMap').appendChild(legend);
                }
                
                console.log(`‚úÖ Carregados ${totalPoints} pontos GPS de ${vehiclesWithGPS} ve√≠culo(s)`);
                
            } catch (error) {
                console.error('Erro ao carregar localiza√ß√µes:', error);
                const statusEl = document.getElementById('mapStatus');
                statusEl.textContent = '‚ùå Erro ao carregar localiza√ß√µes';
                statusEl.style.background = '#f8d7da';
                statusEl.style.color = '#721c24';
            }
        }
        
        function refreshMap() {
            loadVehicleLocations();
        }
        
        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            const btn = document.getElementById('autoRefreshBtn');
            
            if (autoRefreshEnabled) {
                btn.textContent = '‚ñ∂Ô∏è Auto-atualiza√ß√£o: Ligada (30s)';
                btn.style.background = '#28a745';
                btn.style.color = 'white';
                autoRefreshInterval = setInterval(loadVehicleLocations, 30000); // Update every 30 seconds
            } else {
                btn.textContent = '‚è∏Ô∏è Auto-atualiza√ß√£o: Desligada';
                btn.style.background = '';
                btn.style.color = '';
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        }

        // ========================================
        // FILE UPLOAD FUNCTIONALITY
        // ========================================
        
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const uploadResults = document.getElementById('uploadResults');
            const uploadError = document.getElementById('uploadError');
            const uploadProgress = document.getElementById('uploadProgress');
            const uploadBtn = document.getElementById('uploadBtn');
            
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                showUploadError('Por favor, selecione um arquivo para upload');
                return;
            }
            
            const file = fileInput.files[0];
            
            // Show progress
            if (uploadResults) uploadResults.style.display = 'none';
            if (uploadError) uploadError.style.display = 'none';
            if (uploadProgress) uploadProgress.style.display = 'block';
            if (uploadBtn) {
                uploadBtn.disabled = true;
                uploadBtn.textContent = '‚è≥ Processando...';
            }
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch('/api/upload-file', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (uploadProgress) uploadProgress.style.display = 'none';
                if (uploadBtn) {
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = 'üì§ Processar Arquivo';
                }
                
                if (result.success && result.data) {
                    showUploadResults(result.data, file.name);
                    
                    // Refresh map if any GPS data was saved
                    if (result.data.savedToDatabase > 0 && vehicleMap) {
                        setTimeout(() => {
                            loadVehicleLocations();
                        }, 2000);
                    }
                } else {
                    showUploadError(result.error || 'Erro ao processar arquivo');
                }
            } catch (error) {
                if (uploadProgress) uploadProgress.style.display = 'none';
                if (uploadBtn) {
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = 'üì§ Processar Arquivo';
                }
                showUploadError('Erro de conex√£o: ' + (error instanceof Error ? error.message : String(error)));
            }
        }
        
        function showUploadResults(data, fileName) {
            const uploadResults = document.getElementById('uploadResults');
            const uploadError = document.getElementById('uploadError');
            const uploadResultContent = document.getElementById('uploadResultContent');
            
            uploadError.style.display = 'none';
            uploadResults.style.display = 'block';
            
            const successRate = data.totalHexFound > 0 
                ? ((data.savedToDatabase / data.totalHexFound) * 100).toFixed(1)
                : '0';
            
            let html = `
                <div style="margin: 10px 0; padding: 15px; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #28a745;">
                    <h4 style="margin: 0 0 15px 0; color: #2d5a2d;">‚úÖ Processamento Conclu√≠do</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div>
                            <strong>üìÅ Arquivo:</strong><br>
                            <span style="font-size: 0.9em;">${fileName}</span>
                        </div>
                        <div>
                            <strong>üîç Hex Encontrados:</strong><br>
                            <span style="font-size: 1.2em; font-weight: bold; color: #007acc;">${data.totalHexFound}</span>
                        </div>
                        <div>
                            <strong>‚úÖ Decodificados:</strong><br>
                            <span style="font-size: 1.2em; font-weight: bold; color: #28a745;">${data.successfullyDecoded}</span>
                        </div>
                        <div>
                            <strong>üíæ Salvos no Banco:</strong><br>
                            <span style="font-size: 1.2em; font-weight: bold; color: #28a745;">${data.savedToDatabase}</span>
                        </div>
                        <div>
                            <strong>‚ùå Erros:</strong><br>
                            <span style="font-size: 1.2em; font-weight: bold; color: #dc3545;">${data.errors}</span>
                        </div>
                        <div>
                            <strong>üìä Taxa de Sucesso:</strong><br>
                            <span style="font-size: 1.2em; font-weight: bold; color: #28a745;">${successRate}%</span>
                        </div>
                    </div>
                </div>
            `;
            
            if (data.details && data.details.length > 0) {
                html += `
                    <div style="margin-top: 20px;">
                        <h4>üìã Detalhes do Processamento</h4>
                        <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px;">
                `;
                
                data.details.forEach((detail, index) => {
                    const statusIcon = detail.saved ? '‚úÖ' : detail.decoded ? '‚ö†Ô∏è' : '‚ùå';
                    const statusColor = detail.saved ? '#28a745' : detail.decoded ? '#ffc107' : '#dc3545';
                    
                    html += `
                        <div style="padding: 10px; margin: 5px 0; background: #f8f9fa; border-radius: 6px; border-left: 3px solid ${statusColor};">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <strong>${statusIcon} Hex ${index + 1}:</strong> ${detail.hex}<br>
                                    ${detail.deviceId ? `<span style="color: #007acc;">Device ID: ${detail.deviceId}</span><br>` : ''}
                                    ${detail.error ? `<span style="color: #dc3545;">Erro: ${detail.error}</span>` : ''}
                                </div>
                                <div style="margin-left: 10px;">
                                    ${detail.saved ? '<span style="color: #28a745; font-weight: bold;">Salvo</span>' : ''}
                                    ${detail.decoded && !detail.saved ? '<span style="color: #ffc107;">Decodificado</span>' : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            uploadResultContent.innerHTML = html;
        }
        
        function showUploadError(message) {
            const uploadError = document.getElementById('uploadError');
            const uploadErrorContent = document.getElementById('uploadErrorContent');
            const uploadResults = document.getElementById('uploadResults');
            
            uploadResults.style.display = 'none';
            uploadError.style.display = 'block';
            uploadErrorContent.textContent = message;
        }
        
        function clearUploadResults() {
            const fileInput = document.getElementById('fileInput');
            const uploadResults = document.getElementById('uploadResults');
            const uploadError = document.getElementById('uploadError');
            const uploadProgress = document.getElementById('uploadProgress');
            
            fileInput.value = '';
            uploadResults.style.display = 'none';
            uploadError.style.display = 'none';
            uploadProgress.style.display = 'none';
        }

        // ========================================
        // INITIALIZATION
        // ========================================
        
        // Force immediate execution check
        console.log('üîç Script carregado, verificando DOM...');
        console.log('   Document ready state:', document.readyState);
        console.log('   Window loaded:', typeof window !== 'undefined');
        
        function initializeApp() {
            console.log('üöÄ Inicializando aplica√ß√£o...');
            console.log('   Timestamp:', new Date().toISOString());
            
            // Verify all required elements exist
            const requiredElements = {
                'tcpMessages': document.getElementById('tcpMessages'),
                'vehiclesContainer': document.getElementById('vehiclesContainer'),
                'vehicleMap': document.getElementById('vehicleMap'),
                'mapStatus': document.getElementById('mapStatus'),
                'tcpStatusDot': document.getElementById('tcpStatusDot'),
                'tcpStatusText': document.getElementById('tcpStatusText'),
                'vehicleCount': document.getElementById('vehicleCount')
            };
            
            console.log('üìã Verificando elementos DOM:');
            for (const [name, element] of Object.entries(requiredElements)) {
                if (!element) {
                    console.error(`   ‚ùå ${name}: N√ÉO ENCONTRADO`);
                } else {
                    console.log(`   ‚úÖ ${name}: encontrado`);
                }
            }
            
            // Check if sections are visible
            const sections = {
                'tcp-monitor': document.querySelector('.tcp-monitor'),
                'map-section': document.querySelector('#mapContainer'),
                'vehicles-section': document.querySelector('#vehiclesContainer')?.parentElement
            };
            
            console.log('üìã Verificando se√ß√µes:');
            for (const [name, element] of Object.entries(sections)) {
                if (!element) {
                    console.error(`   ‚ùå ${name}: N√ÉO ENCONTRADO`);
                } else {
                    const style = window.getComputedStyle(element);
                    console.log(`   ‚úÖ ${name}: encontrado`, {
                        display: style.display,
                        visibility: style.visibility,
                        opacity: style.opacity,
                        height: style.height
                    });
                }
            }
            
            // Initialize authentication
            try {
                console.log('üîê Carregando autentica√ß√£o...');
                loadAuthFromStorage();
                updateAuthUI();
                console.log('‚úÖ Autentica√ß√£o inicializada');
            } catch (error) {
                console.error('‚ùå Erro ao inicializar autentica√ß√£o:', error);
                console.error('   Stack:', error.stack);
            }
            
            // Initialize TCP Monitor
            try {
                console.log('üì° Inicializando TCP Monitor...');
                initTcpMonitor();
                console.log('‚úÖ TCP Monitor inicializado');
            } catch (error) {
                console.error('‚ùå Erro ao inicializar TCP Monitor:', error);
                console.error('   Stack:', error.stack);
            }
            
            // Load vehicles
            try {
                console.log('üöó Carregando ve√≠culos...');
                loadVehicles();
                console.log('‚úÖ Carregamento de ve√≠culos iniciado');
            } catch (error) {
                console.error('‚ùå Erro ao carregar ve√≠culos:', error);
                console.error('   Stack:', error.stack);
            }
            
            // Initialize map after Leaflet is loaded
            let leafletCheckCount = 0;
            const maxChecks = 50; // 5 seconds max wait
            
            function waitForLeaflet() {
                leafletCheckCount++;
                if (typeof L !== 'undefined') {
                    console.log('‚úÖ Leaflet detectado, inicializando mapa...');
                    setTimeout(() => {
                        try {
                            initMap();
                            console.log('‚úÖ Mapa inicializado com sucesso');
                        } catch (error) {
                            console.error('‚ùå Erro ao inicializar mapa:', error);
                            console.error('   Stack:', error.stack);
                        }
                    }, 500);
                } else if (leafletCheckCount < maxChecks) {
                    if (leafletCheckCount % 10 === 0) {
                        console.log(`‚è≥ Aguardando Leaflet... (${leafletCheckCount}/${maxChecks})`);
                    }
                    setTimeout(waitForLeaflet, 100);
                } else {
                    console.error('‚ùå Timeout aguardando Leaflet carregar');
                    const statusEl = document.getElementById('mapStatus');
                    if (statusEl) {
                        statusEl.textContent = '‚ùå Erro ao carregar biblioteca do mapa';
                        statusEl.style.background = '#f8d7da';
                        statusEl.style.color = '#721c24';
                    }
                }
            }
            waitForLeaflet();
        }
        
        // Try multiple initialization methods
        if (document.readyState === 'loading') {
            console.log('üìù DOM ainda carregando, aguardando DOMContentLoaded...');
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            console.log('üìù DOM j√° carregado, inicializando imediatamente...');
            initializeApp();
        }
        
        // Also try window.onload as fallback
        window.addEventListener('load', function() {
            console.log('ü™ü Window.onload disparado');
            // Double-check if everything is initialized
            if (!document.getElementById('tcpMessages')?.hasChildNodes() || 
                document.getElementById('tcpMessages')?.querySelector('.no-messages')) {
                console.log('‚ö†Ô∏è Verificando se TCP Monitor precisa ser reinicializado...');
            }
        });
    </script>
    
    <!-- Leaflet JavaScript for OpenStreetMap/OpenFreeMaps - Load before initialization -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""
            onload="console.log('‚úÖ Leaflet carregado'); if (typeof initMap === 'function' && typeof L !== 'undefined') { setTimeout(initMap, 100); }"></script>
</body>
</html> 